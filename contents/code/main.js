var W={Cemu:{classes:["cemu","cemu_relwithdebinfo"],primary:/^Cemu/,secondary:/^GamePad View/,settings:{secondaryWindowAspectRatio:16/9,singleScreenLayout:"column-right",multiScreenSingleSecondaryLayout:"separate"}},"Cemu (Proton)":{classes:["steam_app_"],primary:/^Cemu/,secondary:/^GamePad View/,settings:{secondaryWindowAspectRatio:16/9,singleScreenLayout:"column-right",multiScreenSingleSecondaryLayout:"separate"}},Citra:{classes:["citra","citra-qt"],primary:/^Citra((?!Secondary).)*|((?!Secondary).)*/,secondary:/^Citra.*Secondary/,settings:{secondaryWindowAspectRatio:4/3,singleScreenLayout:"column-right",multiScreenSingleSecondaryLayout:"separate"}},Dolphin:{classes:["dolphin-emu"],primary:/^Dolphin$|^(Dolphin.*\|)/,secondary:/^GBA\d+/,settings:{secondaryWindowAspectRatio:3/2,singleScreenLayout:"column-right",multiScreenSingleSecondaryLayout:"separate",multiScreenMultiSecondaryLayout:"column-right"}}};print("!!!KWINSCRIPT!!!");var z=!1,v=!0,d=0,f=0,y={};function S(e){let n=workspace.numScreens;e!=n&&h(500,()=>{let r=workspace.numScreens;S(r)}),print("Configuring screens");for(let r=0;r<e;r++){let o=r,a=workspace.clientArea(KWin.MaximizeArea,o,1),p=workspace.clientArea(KWin.MaximizeArea,d,1),t=workspace.clientArea(KWin.MaximizeArea,f,1);a.height*a.width>p.height*p.width&&(d=o),a.height*a.width<t.height*t.width&&(f=o)}if(z){let r=d;d=f,f=r}print("primary display: ",d,", geometry: ",workspace.clientArea(KWin.MaximizeArea,d,1)),print("secondary display: ",f,", geometry: ",workspace.clientArea(KWin.MaximizeArea,f,1));let i=workspace.clientList();for(let r of i)print("handling client",r.caption,"with class",r.resourceClass.toString()),x(r)}var g={},u=!1,k=!1;function L(e){let n=g[e.windowId];e.geometry=n.geometry,e.fullScreen=n.fullScreen,e.keepAbove=n.keepAbove}function R(e){for(let n in e)for(let i of e[n])if(!i){let r="Scope "+n+" contains invalid window";print(r),assert(i,r)}print("windows are valid")}function P(e){let n=e.width/e.height;return[16/9,16/10,4/3,21/9].some(function(r){return Math.abs(r-n)<.001})}function D(e,n,i,r){var C;let o=workspace.numScreens===1?n.singleScreenLayout:r===1?n.multiScreenSingleSecondaryLayout:(C=n.multiScreenMultiSecondaryLayout)!=null?C:n.multiScreenSingleSecondaryLayout,[a,p]=i===0||o!="separate"?[d,f]:[f,d];print("setting client",e,"on screen",a,"with layout",o,"index",i);let t=workspace.clientArea(KWin.ScreenArea,a,workspace.currentDesktop),c=workspace.clientArea(KWin.ScreenArea,p,workspace.currentDesktop),m=workspace.workspaceHeight-t.height-c.height;m>.1&&!P(t)&&(print("adding",m,"to height to compensate for safe area"),t.height+=m);let w=t.width/2;switch(i>0?r<3&&(o==="square-left"?o="column-left":o==="square-right"&&(o="column-right")):r===0&&(o="separate"),print("layout set to",o,"after analysis"),o){case"separate":if(i>0){let l=r>2?t.height/2:t.height,s=r>1?t.width/2:t.width;i%2==0&&(t.x+=s),i===3&&r===3&&(t.x+=s/2),i>2&&(t.y+=l),t.width=s,t.height=l}break;case"column-left":case"column-right":{let l=t.height/r,s=n.secondaryWindowAspectRatio*l;if(s=w>s?s:w,l=1/n.secondaryWindowAspectRatio*s,i===0)o==="column-left"&&(t.x+=s),t.width-=s;else if(i>0){o==="column-right"&&(t.x+=t.width-s);let A=i-1;t.y+=A*l,t.width=s,t.height=l}}break;case"square-left":case"square-right":{let l=t.height/2,s=n.secondaryWindowAspectRatio*l;if(s=w>s?s:w,l=1/n.secondaryWindowAspectRatio*s,i===0)o==="square-left"&&(t.x+=s*2),t.width-=s*2;else{if(i%2==0&&(t.x+=s),i===3&&r===3&&(t.x+=s/2),i>2&&(t.y+=l),o==="square-right"){let A=t.width-s*2;t.x+=A}t.width=s,t.height=l}break}}i!==0&&(e.fullScreen=!0),v&&(e.keepAbove=!0),e.geometry=t,h(10,()=>{workspace.sendClientToScreen(e,a)})}function F(e,n){if(e.type!="primary"){let i=n.primary[0];i&&i.fullScreen!=u&&(print("resetting fullscreen to",u),i.fullScreen=u)}}function G(e){return e.primary.length+e.secondary.length+e.other.length}function H(e,n,i){print("Setting",n,"windows for app: ",e,":",i)}function b(e,n){F(e,n);let i=e.app,r=G(n);if(r<=1)return;let o=n.primary,a=n.secondary;H(i,r,n);let p=o[0];p&&(o.length>1&&print("too many primary windows; using,",p,"ignoring",o.slice(1).map(c=>c.caption)),p.fullScreen&&D(p,e.settings,0,a?a.length:0)),a.sort((c,m)=>c.caption<m.caption?-1:1);for(let c of a){let m=a.indexOf(c)+1;m<=4?u?(D(c,e.settings,m,a.length),c.fullScreen=!0):(L(c),c.fullScreen=!1,c.keepAbove=!1):print("too many secondary views; ignoring",c.caption)}let t=n.other;for(let c of t)print("handling other window:",c.caption),workspace.sendClientToScreen(c,f),c.fullScreen=!1,c.setMaximize(!0,!0),c.keepAbove=v&&(!u||!a&&workspace.numScreens===1)}function K(e){let n=e.caption,i=e.resourceClass.toString();for(let r in W){let o=W[r],a=o.primary.test(n),p=o.secondary.test(n);if(o.classes.some(t=>i.includes(t))){let t={app:r,type:p?"secondary":a?"primary":"other",settings:o.settings};return print("matched",n,"with",t.app,"priority",t.type),t}}return print(e.caption,"with class",i,"not matched; ignoring"),null}function x(e){let n=K(e);if(e.normalWindow&&n){g[e.windowId]||(g[e.windowId]={geometry:e.geometry,fullScreen:e.fullScreen,keepAbove:e.keepAbove});let i=n.app;if(n.type==="primary"&&(print("attaching fullscreen listener to primary window"),u=e.fullScreen,k=u,e.fullScreenChanged.connect(()=>{!e.fullScreen&&q(!1)&&u?(print("setting fullscreen to former value from fullscreen change"),e.fullScreen=u):(k=u,u=e.fullScreen,print(e.caption,"now fullscreen:",e.fullScreen),b(n,y[i]))})),y[i]){let r=y[i],o=r[n.type];r[n.type]=o?[...o,e]:[e],y[i]=r,R(r),b(n,r)}else{let r={primary:[],secondary:[],other:[]};r[n.type]=[e],y[i]=r}}}var T=new Date("1969-12-29"),M=new Date("1969-12-29");function q(e){let n=new Date;return e?M=n:T=n,Math.abs(T.getTime()-M.getTime())<100}function h(e,n){var i=new QTimer;return i.timeout.connect(function(){i.stop(),n()}),i.start(e),i}var I=0;workspace.clientAdded.connect(x);workspace.clientRemoved.connect(e=>{if(e.windowId in g){L(e),delete g[e.windowId];let n=K(e);if(n===null)return;let i=n.app,r=y[i],o=r.primary,a=++I;if(o&&o[0]&&q(!0)){let p=o[0];h(1e3,()=>{let t=y[i];a==I&&t&&t.primary&&t.primary[0]==p&&(print("setting fullscreen to former value from remove window change"),p.fullScreen=k)})}for(let p of[r.primary,r.secondary,r.other].filter(t=>t)){let t=p.indexOf(e);t>-1&&p.splice(t,1)}y[i]=r,R(r),b(n,r)}});workspace.numberScreensChanged.connect(e=>{h(2e3,()=>S(e))});workspace.screenResized.connect(e=>{if(d===e||f===e){let n=workspace.numScreens;h(500,()=>S(n))}});var O=workspace.numScreens;S(O);
